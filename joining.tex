\documentclass[ignorenonframetext,]{beamer}
\setbeamertemplate{caption}[numbered]
\setbeamertemplate{caption label separator}{: }
\setbeamercolor{caption name}{fg=normal text.fg}
\beamertemplatenavigationsymbolsempty
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\newif\ifbibliography
\hypersetup{
            pdftitle={Joining data frames in R using dplyr},
            pdfauthor={Erika Braithwaite \& Kathryn Morrison},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight0.8\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}

% Prevent slide breaks in the middle of a paragraph:
\widowpenalties 1 10000
\raggedbottom

\AtBeginPart{
  \let\insertpartnumber\relax
  \let\partname\relax
  \frame{\partpage}
}
\AtBeginSection{
  \ifbibliography
  \else
    \let\insertsectionnumber\relax
    \let\sectionname\relax
    \frame{\sectionpage}
  \fi
}
\AtBeginSubsection{
  \let\insertsubsectionnumber\relax
  \let\subsectionname\relax
  \frame{\subsectionpage}
}

\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}

\title{Joining data frames in R using dplyr}
\subtitle{RLadies Montreal}
\author{Erika Braithwaite \& Kathryn Morrison}
\date{March 15, 2018}

\begin{document}
\frame{\titlepage}

\begin{frame}[fragile]{What is joining?}

We often run into scenarios where we need to join two data frames
together. Let's say we had some students who were given an IQ test at a
career fair. Some of the students showed up at on both days, but not
all. They were given unique alphabetic identifiers (A-Q)

Set up

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#install.packages('pacman')}
\NormalTok{pacman}\OperatorTok{::}\KeywordTok{p_load}\NormalTok{(knitr, kableExtra, data.table, dplyr, }
\NormalTok{               rmarkdown, magrittr, xtable)}
\end{Highlighting}
\end{Shaded}

Make some data

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{day1 =}\StringTok{  }\KeywordTok{data.table}\NormalTok{(}\DataTypeTok{ID=}\NormalTok{LETTERS[}\DecValTok{1}\OperatorTok{:}\DecValTok{12}\NormalTok{], }\DataTypeTok{IQ=}\KeywordTok{round}\NormalTok{(}\KeywordTok{rnorm}\NormalTok{(}\DecValTok{12}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{15}\NormalTok{),}\DecValTok{2}\NormalTok{))}

\NormalTok{day2 =}\StringTok{  }\KeywordTok{data.table}\NormalTok{(}\DataTypeTok{ID=}\NormalTok{LETTERS[}\DecValTok{6}\OperatorTok{:}\DecValTok{17}\NormalTok{],}\DataTypeTok{IQ=}\KeywordTok{round}\NormalTok{(}\KeywordTok{rnorm}\NormalTok{(}\DecValTok{12}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{20}\NormalTok{),}\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

There are 12 individuals on day 1 and 12 individuals on day 2. 17 people
have a single measurement while 5 have 2 measurements

\end{frame}

\begin{frame}[fragile]{Our data}

ID

IQ

A

119.24

B

84.31

C

109.48

D

77.60

E

88.19

F

87.73

G

88.26

H

137.23

I

81.17

J

107.38

K

104.48

L

98.82

ID

IQ

F

89.01

G

124.34

H

103.09

I

112.67

J

116.86

K

106.20

L

74.36

M

136.07

N

108.39

O

118.75

P

121.31

Q

89.64

Let's explore the three(ish) types of joins in \texttt{dplyr}

\end{frame}

\begin{frame}[fragile]{Mutating joins}

\begin{block}{Add a new variables to one table from matching rows in
another}

The order in which we specify the data frames in the \texttt{join}
function determines which is considered primary (left) versus secondary
(right)

\begin{itemize}
\tightlist
\item
  \texttt{left\_join}: retains rows in first data frame specified if it
  has a match in the secondary
\item
  \texttt{right\_join}: retains rows in the secondary data frame
  specified if it has a match in the primary (equivalent to
  \texttt{left\_join} if you invert order of data frames)
\item
  \texttt{inner\_join}: retains rows present in both data frame\\
\item
  \texttt{full\_join}: retains all rows in either data frames
\end{itemize}

Left, right and full joins are considered outer joins because when a row
doesn't match, the columns are filled with \texttt{NA} instead of being
dropped by the \texttt{join}. Furthermore, multiple matches on the key
will result in all combinations being returned.

\end{block}

\end{frame}

\begin{frame}[fragile]{Filtering joins}

\begin{block}{Filter observations from the primary based on whether they
are present in the secondary table}

\begin{itemize}
\tightlist
\item
  \texttt{semi\_join}: retains rows in the primary table that have a
  match in secondary table
\item
  \texttt{anti\_join}: drops rows in the primary table that have a match
  in secondary table
\end{itemize}

Filtering joins act as a filter in that they change the number of rows
but not the columns. Unlike mutating joins, rows are never duplicated
(as in the case of an inner join). Only columns from the primary data
frame are retained.

\end{block}

\end{frame}

\begin{frame}[fragile]{Set operations}

\begin{block}{Combines operations in the dataset as if they were set
elements. Much like filtering joins, they do not add new columns. Set
operations use combinations of observations from both data frames to
create a new data frame}

\begin{itemize}
\tightlist
\item
  \texttt{intersect}: retains rows ONLY if they appear in both data
  frames
\item
  \texttt{union}: retains rows that appear in EITHER data frames
\item
  \texttt{setdiff}: retains rows that ONLY appear in the primary data
  frame but not the second
\end{itemize}

\end{block}

\end{frame}

\begin{frame}[fragile]{Main arguments}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{right_join}\NormalTok{(x, y, }\DataTypeTok{by =} \OtherTok{NULL}\NormalTok{, }\DataTypeTok{copy =} \OtherTok{FALSE}\NormalTok{, }\DataTypeTok{suffix =} \KeywordTok{c}\NormalTok{(}\StringTok{'.x'}\NormalTok{, }\StringTok{'.y'}\NormalTok{), ...)}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\tightlist
\item
  \texttt{y} and \texttt{y} are the two data frames we are joining
\item
  \texttt{by} = primary key variable (typically a unique identifier)
  which can be one or several columns. The foreign key is the
  indentifier in the secondary table, which will be matched to the
  primary tables based on the primary key.
\item
  \texttt{copy} = copy values of secondary to the primary
\item
  \texttt{suffix} will add a suffix to columns when they have the same
  name, e.g. \texttt{x.IQ} and \texttt{y.IQ}.
\end{itemize}

\end{frame}

\begin{frame}[fragile]{Mutating joins: left join}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{left_join}\NormalTok{(day1, day2, }\DataTypeTok{by =} \StringTok{'ID'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable}\NormalTok{(}\StringTok{'html'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{font_size =} \DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

ID

IQ.x

IQ.y

A

119.24

NA

B

84.31

NA

C

109.48

NA

D

77.60

NA

E

88.19

NA

F

87.73

89.01

G

88.26

124.34

H

137.23

103.09

I

81.17

112.67

J

107.38

116.86

K

104.48

106.20

L

98.82

74.36

\end{frame}

\begin{frame}[fragile]{Mutating joins: right join}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{right_join}\NormalTok{(day1, day2, }\DataTypeTok{by =} \StringTok{'ID'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable}\NormalTok{(}\StringTok{'html'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{font_size =} \DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

ID

IQ.x

IQ.y

F

87.73

89.01

G

88.26

124.34

H

137.23

103.09

I

81.17

112.67

J

107.38

116.86

K

104.48

106.20

L

98.82

74.36

M

NA

136.07

N

NA

108.39

O

NA

118.75

P

NA

121.31

Q

NA

89.64

\end{frame}

\begin{frame}[fragile]{Mutating joins: inner join}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{inner_join}\NormalTok{(day1, day2, }\DataTypeTok{by =} \StringTok{'ID'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable}\NormalTok{(}\StringTok{'html'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{font_size =} \DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

ID

IQ.x

IQ.y

F

87.73

89.01

G

88.26

124.34

H

137.23

103.09

I

81.17

112.67

J

107.38

116.86

K

104.48

106.20

L

98.82

74.36

\end{frame}

\begin{frame}[fragile]{Mutating joins: full join}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{full_join}\NormalTok{(day1, day2, }\DataTypeTok{by =} \StringTok{'ID'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable}\NormalTok{(}\StringTok{'html'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{font_size =} \DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

ID

IQ.x

IQ.y

A

119.24

NA

B

84.31

NA

C

109.48

NA

D

77.60

NA

E

88.19

NA

F

87.73

89.01

G

88.26

124.34

H

137.23

103.09

I

81.17

112.67

J

107.38

116.86

K

104.48

106.20

L

98.82

74.36

M

NA

136.07

N

NA

108.39

O

NA

118.75

P

NA

121.31

Q

NA

89.64

\end{frame}

\begin{frame}[fragile]{Filtering joins: semi join}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{semi_join}\NormalTok{(day1, day2, }\DataTypeTok{by =} \StringTok{'ID'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable}\NormalTok{(}\StringTok{'html'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{font_size =} \DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

ID

IQ

F

87.73

G

88.26

H

137.23

I

81.17

J

107.38

K

104.48

L

98.82

\end{frame}

\begin{frame}[fragile]{Filtering joins: anti join}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{anti_join}\NormalTok{(day1, day2, }\DataTypeTok{by =} \StringTok{'ID'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable}\NormalTok{(}\StringTok{'html'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{font_size =} \DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

ID

IQ

A

119.24

B

84.31

C

109.48

D

77.60

E

88.19

\end{frame}

\begin{frame}[fragile]{Set operations: intersect}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{intersect}\NormalTok{(day1, day2, }\DataTypeTok{by =} \StringTok{'ID'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable}\NormalTok{(}\StringTok{'html'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{font_size =} \DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

ID

IQ

\end{frame}

\begin{frame}[fragile]{Set operations: union}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{union}\NormalTok{(day1, day2, }\DataTypeTok{by =} \StringTok{'ID'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable}\NormalTok{(}\StringTok{'html'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{font_size =} \DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

ID

IQ

Q

89.64

P

121.31

O

118.75

N

108.39

M

136.07

L

74.36

J

116.86

K

106.20

I

112.67

H

103.09

G

124.34

F

89.01

L

98.82

K

104.48

J

107.38

I

81.17

H

137.23

G

88.26

F

87.73

E

88.19

D

77.60

C

109.48

B

84.31

A

119.24

\end{frame}

\begin{frame}[fragile]{Set operations: setdiff}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{setdiff}\NormalTok{(day1, day2, }\DataTypeTok{by =} \StringTok{'ID'}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable}\NormalTok{(}\StringTok{"html"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{        }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{font_size =} \DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

ID

IQ

A

119.24

B

84.31

C

109.48

D

77.60

E

88.19

F

87.73

G

88.26

H

137.23

I

81.17

J

107.38

K

104.48

L

98.82

\end{frame}

\begin{frame}[fragile]{dplyr versus \ldots{}}

\begin{block}{Base R: \texttt{merge}}

\begin{itemize}
\tightlist
\item
  Slower than \texttt{dplyr}
\item
  Can't handle lists of data frames
\item
  \texttt{rbind} returns an error when columns are not identical
\item
  \texttt{dplyr}'s \texttt{.id} argument allows you to specify a name
  for each source data frame
\end{itemize}

\end{block}

\begin{block}{Data.table: \texttt{data.table::merge}}

While this point is contentious, if you've been a long standing
tidyversalist, then you might find \texttt{data.table::merge} syntax
more difficult to learn. Some people prefer \texttt{dplyr} because

\begin{itemize}
\tightlist
\item
  tells you what keys you're merging of (if not supplied)
\item
  rows are kept in existing order
\item
  also works with database tables
\end{itemize}

\end{block}

\end{frame}

\begin{frame}{Benchmarking exercise}

\begin{figure}
\centering
\includegraphics{graphs/benchmark.png}
\caption{benchmark}
\end{figure}

\end{frame}

\begin{frame}{When joining can get tricky\ldots{}}

\begin{itemize}
\tightlist
\item
  Joining columns having the same name but different encoding (UTF-8
  vs.~Latin)
\item
  Joining columns having different storage types (factors, integers,
  bit64, dates)
\end{itemize}

The consequences can vary, but dplyr might

\begin{itemize}
\tightlist
\item
  Set all the values to NA
\item
  Coerce a column to another type (e.g.~factor to character)
\item
  Fail to recognize columns that match resulting in rows being dropped
\end{itemize}

\end{frame}

\begin{frame}[fragile]{More!}

There are additional types of joins not covered here such as rolling
joins or cross joins

Rolling joins are used in circumstances where you want to join
observations based on logical arguments (i.e.~range of date).

Cross joins are used when we do not have a key on which we wish we
match, rather we are simply returns every single combination of rows
between two data frames.

If you want to join 3 or more tables, go check out how a \texttt{list}
and \texttt{reduce} from \texttt{base\ R} or \texttt{purrr::reduce} can
help you.

\end{frame}

\end{document}
